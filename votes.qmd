---
title: "Votes"
format: 
  html:
    page-layout: full
freeze: auto
execute:
  echo: false
  warning: false
  error: true  
---

[Vote entry link can be found here.](https://docs.google.com/spreadsheets/d/1O3c2ZGWMUwBu_q2Yjr0nbfBOn9qD2T3A_zhYH8Q2ZHs/edit?gid=0#gid=0)

```{r}
library(readr)
library(dplyr)
library(gt)
library(janitor)

bills_csv <- "files/csvs/bill_list.csv"
senator_csv <- "files/csvs/senator_list.csv"
b_pages_dir  <- "bills-pages"

senators <- read.csv(senator_csv)
senators$Name <- paste(senators$First.Name, senators$Last.Name, sep = " ")
senators$Name <- trimws(gsub("\\s+", " ", senators$Name)) 
s_names <- senators$Name
d_sen <- senators$Name[senators$Party == "D"]
r_sen <- senators$Name[senators$Party == "R"]

bills <- read.csv(bills_csv)
bills$bill_numbersb <- paste0("SB-", bills$bill_number)
bills$lastname_nospace <- gsub(" ", "_", bills$Last.Name)

# Function for creating final vote tables
process_votes_table <- function(votes_csv){

  dat <- read.csv(votes_csv)

  if(nrow(dat) == 0) {
    return(NULL)
  }

  dat <- dat %>%
    rename_with(~ gsub("\\.", " ", .x)) %>%  
    rowwise() %>%
    mutate( 
          Bill = as.character(Bill),
          yes = sum(c_across(any_of(s_names)) == "Aye", na.rm = TRUE),
          no = sum(c_across(any_of(s_names)) == "No", na.rm = TRUE),
          abstain = sum(c_across(any_of(s_names)) == "Abstain", na.rm = TRUE),
          absent = sum(c_across(any_of(s_names)) == "" | is.na(c_across(any_of(s_names)))),
          Vote = paste(yes, no, abstain, absent, sep = "-"),
          d_yes = sum(c_across(any_of(d_sen)) == "Aye", na.rm = TRUE),
          d_no = sum(c_across(any_of(d_sen)) == "No", na.rm = TRUE),
          d_abstain = sum(c_across(any_of(d_sen)) == "Abstain", na.rm = TRUE),
          d_absent = sum(c_across(any_of(d_sen)) == "" | is.na(c_across(any_of(d_sen)))),
          Dem_vote = paste(d_yes, d_no, d_abstain, d_absent, sep = "-"),
          Dem_percent = round((d_yes/(d_yes + d_no + d_abstain)*100)),
          Dem_percent_sign = paste0(Dem_percent, "%"),
          r_yes = sum(c_across(any_of(r_sen)) == "Aye", na.rm = TRUE),
          r_no = sum(c_across(any_of(r_sen)) == "No", na.rm = TRUE),
          r_abstain = sum(c_across(any_of(r_sen)) == "Abstain", na.rm = TRUE),
          r_absent = sum(c_across(any_of(r_sen)) == "" | is.na(c_across(any_of(r_sen)))),
          Rep_vote = paste(r_yes, r_no, r_abstain, r_absent, sep = "-"),
          Rep_percent = round((r_yes/(r_yes + r_no + r_abstain)*100)),
          Rep_percent_sign = paste0(Rep_percent, "%")
          ) %>%
    left_join(bills, by = c("Bill" = "bill_numbersb")) %>%
    mutate(billnumname = paste0(toupper(lastname_nospace), "_SB", bill_number),
          Bill = sprintf("[%s](/%s/%s.html)", Bill, b_pages_dir, billnumname)) %>%
    mutate(across(any_of(s_names), ~ ifelse(.x == "", NA, .x))) %>%        
    select(Date, Bill, Vote, Result, Dem_percent_sign, Rep_percent_sign, any_of(s_names)) %>%
    arrange(desc(Date))

  # Return the gt table
  dat %>%
    gt() %>%
    fmt_markdown(columns = "Bill") %>%
    tab_options(
      table.width = pct(100)  # Force table to use full width
    ) %>%
    cols_label(
      Vote = "Vote (Aye-No-Abstain-Absent)",
      Dem_percent_sign = "Democrat Support",
      Rep_percent_sign = "Republican Support"
    ) %>%
    tab_header(
      title = md("**Votes**"),
      subtitle = paste0("Last updated: ", format(Sys.time(), "%Y-%m-%d %H:%M %Z"))
    ) %>%
    fmt_missing(columns = everything(), missing_text = "â€”") %>%
    opt_interactive(
      use_sorting = TRUE,
      use_search = TRUE,
      use_filters = FALSE,
      use_resizers = TRUE,
      use_highlight = TRUE,
      page_size_default = 20
    ) %>%
    opt_row_striping() 
}

```

::: {.panel-tabset}

## Local Government and Labor

```{r}

process_votes_table("https://docs.google.com/spreadsheets/d/e/2PACX-1vSWsxVKMyPrvGZW1VFD0_DdTsMmH-dzITniXvWusbbG34FPwj7uWsIDB6B_6Sb5AdK94SbZ75eL0vTT/pub?gid=0&single=true&output=csv") 

```

## Agriculture and Natural Resources

```{r}

process_votes_table("https://docs.google.com/spreadsheets/d/e/2PACX-1vSWsxVKMyPrvGZW1VFD0_DdTsMmH-dzITniXvWusbbG34FPwj7uWsIDB6B_6Sb5AdK94SbZ75eL0vTT/pub?gid=1077921709&single=true&output=csv")  

```

## Business, Law, and Health

```{r}

process_votes_table("https://docs.google.com/spreadsheets/d/e/2PACX-1vSWsxVKMyPrvGZW1VFD0_DdTsMmH-dzITniXvWusbbG34FPwj7uWsIDB6B_6Sb5AdK94SbZ75eL0vTT/pub?gid=1971997036&single=true&output=csv")


```

## Appropriations

```{r}

process_votes_table("https://docs.google.com/spreadsheets/d/e/2PACX-1vSWsxVKMyPrvGZW1VFD0_DdTsMmH-dzITniXvWusbbG34FPwj7uWsIDB6B_6Sb5AdK94SbZ75eL0vTT/pub?gid=578574660&single=true&output=csv")

```

## Floor

```{r}

process_votes_table("https://docs.google.com/spreadsheets/d/e/2PACX-1vSWsxVKMyPrvGZW1VFD0_DdTsMmH-dzITniXvWusbbG34FPwj7uWsIDB6B_6Sb5AdK94SbZ75eL0vTT/pub?gid=192921423&single=true&output=csv")

```