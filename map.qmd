---
title: "District Map"
format: 
  html:
    page-layout: full
    resources:
      - "files/other/ca_senate_districts.geojson"
execute:
  echo: false
  warning: false
  message: false
---

```{r}

library(leaflet)
library(sf)
library(htmlwidgets)
library(tidyverse)

# Read the GeoJSON data
districts <- suppressMessages(st_read("files/other/ca_senate_districts.geojson"))

senators <- suppressMessages(read.csv("files/csvs/senator_list.csv"))
senators <- senators %>%
  mutate(namesmatch = gsub(" ", "", Last.Name),
        namesmatch = tolower(namesmatch),
        name = paste(Last.Name, First.Name, sep = ", "))

senators$Name_Link <- paste0("/senator-pages/district_", senators$District)

districts <- left_join(districts, senators, by = c("district" = "District"))

# Create map
leaflet(districts) %>%
  addTiles() %>%  # Add base map
  addPolygons(
    weight = 1,
    opacity = 1,
    color = "#5145ff",
    dashArray = "3",
    fillOpacity = 0.4,
    layerId = ~district,  # Add this line to ensure proper layer identification
    highlight = highlightOptions(
      weight = 3,
      color = "#f3df2f",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE
    ),
    label = ~paste("District", district),  
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "13px",
      direction = "auto"
    )
 ) %>%
  htmlwidgets::onRender("
    function(el, x) {
      console.log('Map initialized, adding click events...');
      
      // Add click event to all polygons
      this.eachLayer(function(layer) {
        console.log('Processing layer:', layer);
        
        if (layer.feature && layer.feature.properties) {
          console.log('Layer has feature with properties:', layer.feature.properties);
          
          layer.on('click', function(e) {
            console.log('Click event fired!');
            console.log('Clicked feature properties:', e.target.feature.properties);
            
            // Get the district number from the feature properties
            var district = e.target.feature.properties.district;
            console.log('District:', district);
            
            // Construct URL directly from district number
            var url = '/senator-pages/district_' + district + '.html';
            console.log('Attempting to open URL:', url);
            
            // Navigate to the page
            window.open(url, '_blank');
          });
        } else {
          console.log('Layer without feature/properties:', layer);
        }
      });
    }
  ") %>%
  setView(lng = -120, lat = 36.5, zoom = 5) 
```

